{% extends "base.html" %}
{% block title %}{{ document.title }}{% endblock %}
{% block content %}
<div class="space-y-4">
    <div class="flex justify-between items-start">
        <div>
            <a href="/admin/documents" class="text-blue-600 text-sm">&larr; Retour</a>
            <h1 class="text-2xl font-bold mt-2">{{ document.title }}</h1>
        </div>
        <div class="flex gap-2">
            <a href="/admin/documents/{{ document.id }}/edit" class="px-4 py-2 bg-gray-600 text-white rounded">Modifier</a>
            <form hx-post="/admin/documents/{{ document.id }}/delete" hx-confirm="Supprimer ce document?">
                <button class="px-4 py-2 bg-red-600 text-white rounded">Supprimer</button>
            </form>
        </div>
    </div>

    <div class="bg-white rounded shadow p-4 grid grid-cols-4 gap-4">
        <div>
            <div class="text-sm text-gray-500">Type</div>
            <div class="font-medium">{{ document.source_type }}</div>
        </div>
        <div>
            <div class="text-sm text-gray-500">Categorie</div>
            <div class="font-medium">{{ document.category }}</div>
        </div>
        <div>
            <div class="text-sm text-gray-500">Niveau</div>
            <div>
                <span class="px-2 py-0.5 rounded text-white {% if document.truth_level == 'L1' %}bg-green-500{% elif document.truth_level == 'L2' %}bg-blue-500{% elif document.truth_level == 'L3' %}bg-amber-500{% else %}bg-red-500{% endif %}">{{ document.truth_level }}</span>
                {% if document.truth_level != 'L1' %}
                <button hx-post="/admin/documents/{{ document.id }}/promote" class="ml-2 text-sm text-blue-600">Promouvoir</button>
                {% endif %}
            </div>
        </div>
        <div>
            <div class="text-sm text-gray-500">Status</div>
            <div class="font-medium">{{ document.verification_status }}</div>
        </div>
    </div>

    <div class="bg-white rounded shadow p-4">
        <div class="flex justify-between items-center mb-2">
            <div class="text-sm text-gray-500">Contenu</div>
            <div class="flex gap-2">
                <button id="btn-preview" class="px-3 py-1 text-sm bg-blue-600 text-white rounded">Preview</button>
                <button id="btn-source" class="px-3 py-1 text-sm bg-gray-200 text-gray-700 rounded">Source</button>
            </div>
        </div>
        <!-- Source view (hidden by default) -->
        <div id="content-source" class="hidden">
            <pre class="bg-gray-50 p-4 rounded overflow-x-auto text-sm font-mono whitespace-pre-wrap">{{ document.content }}</pre>
        </div>
        <!-- Markdown preview (visible by default) -->
        <div id="content-preview" class="prose prose-lg max-w-none"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Raw content from Jinja
    const rawContent = {{ document.content | tojson | safe }};

    // Configure marked with syntax highlighting
    marked.setOptions({
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                try {
                    return hljs.highlight(code, { language: lang }).value;
                } catch (e) {}
            }
            return hljs.highlightAuto(code).value;
        },
        breaks: true,
        gfm: true
    });

    // Render markdown preview
    const previewEl = document.getElementById('content-preview');
    const sourceEl = document.getElementById('content-source');
    const btnPreview = document.getElementById('btn-preview');
    const btnSource = document.getElementById('btn-source');

    previewEl.innerHTML = marked.parse(rawContent);

    // Toggle between preview and source
    btnPreview.addEventListener('click', function() {
        previewEl.classList.remove('hidden');
        sourceEl.classList.add('hidden');
        btnPreview.classList.remove('bg-gray-200', 'text-gray-700');
        btnPreview.classList.add('bg-blue-600', 'text-white');
        btnSource.classList.remove('bg-blue-600', 'text-white');
        btnSource.classList.add('bg-gray-200', 'text-gray-700');
    });

    btnSource.addEventListener('click', function() {
        sourceEl.classList.remove('hidden');
        previewEl.classList.add('hidden');
        btnSource.classList.remove('bg-gray-200', 'text-gray-700');
        btnSource.classList.add('bg-blue-600', 'text-white');
        btnPreview.classList.remove('bg-blue-600', 'text-white');
        btnPreview.classList.add('bg-gray-200', 'text-gray-700');
    });
});
</script>
{% endblock %}
