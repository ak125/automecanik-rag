name: RAG Eval Gate

on:
  workflow_dispatch:
    inputs:
      rag_url:
        description: "RAG API base URL (e.g. https://rag.example.com)"
        required: true
        default: "http://127.0.0.1:8000"
      eval_set:
        description: "Eval set file path"
        required: true
        default: "tests/eval_set.json"
      min_catalog_recall:
        description: "Minimum KB_Catalog recall"
        required: true
        default: "0.90"
      max_no_evidence_rate:
        description: "Maximum no-evidence rate"
        required: true
        default: "0.05"
      min_satisfaction:
        description: "Minimum satisfaction"
        required: true
        default: "0.90"

permissions:
  contents: read

jobs:
  eval-gate:
    name: Eval + Threshold Gate
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run eval set
        env:
          RAG_API_KEY: ${{ secrets.RAG_API_KEY }}
        run: |
          if [ -z "$RAG_API_KEY" ]; then
            echo "Missing secret: RAG_API_KEY"
            exit 1
          fi
          python tests/run_eval_set.py \
            --url "${{ inputs.rag_url }}" \
            --eval-set "${{ inputs.eval_set }}" \
            --out tests/eval_report_ci.json

      - name: Enforce quality gate
        run: |
          python tests/check_eval_thresholds.py \
            --report tests/eval_report_ci.json \
            --min-catalog-recall "${{ inputs.min_catalog_recall }}" \
            --max-no-evidence-rate "${{ inputs.max_no_evidence_rate }}" \
            --min-satisfaction "${{ inputs.min_satisfaction }}"

      - name: Publish summary
        if: always()
        run: |
          echo "## RAG Eval Gate" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f tests/eval_report_ci.json ]; then
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat tests/eval_report_ci.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "No eval report produced." >> $GITHUB_STEP_SUMMARY
          fi
